<section class="entity-full-list">
    <?php
        $this->headLink()->appendStylesheet('/js/jquery-ui/jquery-ui.css');
        $this->headScript()->appendFile('/js/jquery-ui/jquery-ui.js');        
        
        $lines = $this->data;        
        $keys = array_keys(array_values($lines)[0]);
        $startDate = $this->startDate;
        $endDate = $this->endDate;
        $typeName = $this->typeName;
    ?>
    <style>
        .reserved {
            color: red;
        }
        .free {
            color: lightgreen;
        }
        
        .tooltip {
            font-size: 0.5em;
        }
    </style>
    <h3><?php echo isset($this->typeName) ? $this->typeName : "Room";?> Availability Status <?php 
        if(isset($startDate) && isset($endDate))
        {
            echo 'for period from '.date('d.m.Y.', strtotime($startDate)).' to '.date('d.m.Y.', strtotime($endDate));
        }
        ?><br><br><br></h3>
    <table class="table">
        <tr>
            <?php foreach($keys as $key):?>
            <th><?php echo $key?></th>
            <?php endforeach;?>
        </tr>
        <?php foreach($lines as $line):?>
        <tr data-object-id="<?php echo $line['guid']?>">
            <?php 
                foreach($keys as $key)
                {
                    $content = $line[$key];
                    if(is_array($content))
                    {
                        $value = $content['status'];
                        $reservation_id = $content['id'];
                        if(isset($content['time_resolution']))
                        {
                            $time_resolution = $content['time_resolution'];
                        }                        
                    }
                    else 
                    {
                        $value = $content;
                    }
                    
                    if($value == 'reserved')
                    {                        
                        if(isset($reservation_id))
                        {
                            echo '<td class="reserved" data-reservation-id="'.$reservation_id.'" data-reservation-contents="">'.$value.'</td>';
                        }
                        else 
                        {
                            echo '<td class="reserved" data-reservation-id="none">'.$value.'</td>';
                        }
                        
                    }
                    else if ($value == 'free')
                    {
                        echo '<td class="free" data-reservation-date="'.$key.'" data-time-resolution="'.$time_resolution.'" title="this is free">'.$value.'</td>';
                    }
                    else 
                    {
                        echo '<td>'.$value.'</td>';
                    }
                }
            ?>
        </tr>
        <?php endforeach;?>
    </table>        
    <script>
        $(function() {
            $('td.reserved').tooltip({    
                items: '[data-reservation-contents]',
                show: {effect: "blind", duration:400},
                content: "loading...",
                create: function(evt, ui) {
                    var id = $(this).data().reservationId;            
                    $.get('/pms/ajax/reservationDetails?id='+id, function(data){
                        data = JSON.parse(data);
                        var html = "<table style='font-size:0.75em'>";
                        $.each(data, function(idx, val) {
                            html += "<tr><td style='font-weight: bold'>"+idx+":&nbsp;</td><td>"+val+"</td></tr>"
                        })
                        html += "</table>";
                        $(evt.target).tooltip('option', 'content', html);
                    });                                    
               }
            });
            
            $('td.reserved').on('mouseleave', function(evt) {
                setTimeout(function() {
                    $(evt.target).tooltip('close');
                });                
            });            
             
            $('td.reserved').on('dblclick', function(evt) {
                var id = $(evt.target).data().reservationId;                                
                window.location.href = "/pms/reservation/edit/"+id;
            });
            
            $('td.free').on('dblclick', function(evt) {
                var startDate = $(evt.target).data().reservationDate;
                var time = $(evt.target).data().timeResolution;
                var guid = $(evt.target).parent('tr').data().objectId;
                //alert("Start date is " + startDate + ", room number is " + guid);
                window.location.href = "/pms/reservation/newEntity?guid="+guid+"&startDate="+startDate+"&time="+time;
            });
        });
    </script>
</section>
